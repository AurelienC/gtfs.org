### fare_transfer_rules.txt

Fichier : **facultatif**

Clé primaire`(from_leg_group_id, to_leg_group_id, fare_product_id, transfer_count, duration_limit`)

Règles tarifaires pour les transferts entre les étapes du voyage définies dans [`fare_leg_rules.txt`](#fare_leg_rulestxt).

Pour traiter le coût d'un voyage à plusieurs étapes :

1. Les groupes de segments tarifaires applicables définis dans `fare_leg_rules.txt` doivent être déterminés pour tous les segments de voyage individuels en fonction du voyage du coureur.

2. Le fichier `fare_transfer_rules.txt` doit être filtré par les champs qui définissent les caractéristiques du transfert, ces champs sont :
   - `fare_transfer_rules.from_leg_group_id`
   - `fare_transfer_rules.to_leg_group_id`<br/>
   <br/>

3. Si le transfert correspond exactement à un enregistrement dans `fare_transfer_rules.txt` en fonction des caractéristiques du transfert, cet enregistrement doit être traité pour déterminer le coût du transfert.

4. Si aucune correspondance exacte n'est trouvée, les entrées vides dans `from_leg_group_id` ou dans `to_leg_group_id` doivent être vérifiées pour traiter le coût du transfert :
   - Une entrée vide dans `fare_transfer_rules.from_leg_group_id` correspond à tous les groupes de jambes définis dans `fare_leg_rules.leg_group_id`, à l'exclusion de ceux énumérés dans `fare_transfer_rules.from_leg_group_id`.
   - Une entrée vide dans `fare_transfer_rules.to_leg_group_id` correspond à tous les groupes de segments définis dans `fare_leg_rules.leg_group_id`, à l'exception de ceux énumérés dans `fare_transfer_rules.to_leg_group_id`.<br/>
   <br/>

5. Si le transfert ne correspond à aucune des règles décrites ci-dessus, il n'y a pas d'arrangement de transfert et les segments sont considérés comme distincts.

<br />

| Nom du champ          | Type                                                                   | Présence                       | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| --------------------- | ---------------------------------------------------------------------- | ------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `from_leg_group_id`   | Référencement d'identifiants étrangers `fare_leg_rules.leg_group_id`   | Facultatif                     | Identifie un groupe de règles de segment tarifaire de pré-transfert.<br /><br />Si aucune valeur ne correspond `fare_transfer_rules.from_leg_group_id` correspondant à l'élément `leg_group_id` en cours de filtrage, des valeurs vides `fare_transfer_rules.from_leg_group_id` sera utilisé par défaut. <br /><br />Une entrée vide dans `fare_transfer_rules.from_leg_group_id` correspond à tous les groupes de jambes définis sous `fare_leg_rules.leg_group_id` à l'exclusion de ceux énumérés sous `fare_transfer_rules.from_leg_group_id`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| `to_leg_group_id`     | Référencement d'identifiants étrangers `fare_leg_rules.leg_group_id`   | Facultatif                     | Identifie un groupe de règles de segment tarifaire post-transfert.<br /><br />Si aucune valeur ne correspond `fare_transfer_rules.to_leg_group_id` correspondant à l'élément `leg_group_id` en cours de filtrage, des valeurs vides `fare_transfer_rules.to_leg_group_id` sera trouvée par défaut.<br /><br />Une entrée vide dans `fare_transfer_rules.to_leg_group_id` correspond à tous les groupes de jambes définis sous `fare_leg_rules.leg_group_id` à l'exclusion de ceux énumérés sous `fare_transfer_rules.to_leg_group_id`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| `transfer_count`      | Entier non nul                                                         | **Interdit sous condition**    | Définit le nombre de transferts consécutifs auxquels la règle de transfert peut être appliquée.<br /><br />Les options valides sont :<br />`-1` - Aucune limite.<br />`1` ou plus - Définit le nombre de transferts que la règle de transfert peut couvrir.<br /><br />Si un sous-transfert correspond à plusieurs enregistrements avec différents `transfer_count`différents, alors la règle dont le minimum `transfer_count` qui est supérieure ou égale au nombre de transferts actuels du sous-voyage doit être sélectionnée.<br /><br />Interdit sous condition :<br />- **Interdit** si `fare_transfer_rules.from_leg_group_id` n'est pas égal `fare_transfer_rules.to_leg_group_id`.<br />- **Obligatoire** si `fare_transfer_rules.from_leg_group_id` est égal à `fare_transfer_rules.to_leg_group_id`.                                                                                                                                                                                                                                                                                                     |
| `duration_limit`      | Nombre entier positif                                                  | Facultatif                     | Définit la limite de durée du transfert.<br /><br />Elle doit être exprimée en incréments entiers de secondes.<br /><br />S'il n'y a pas de limite de durée, `fare_transfer_rules.duration_limit` doit être vide.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| `duration_limit_type` | Enum                                                                   | **Obligatoire sous condition** | Définit le début et la fin relatifs de `fare_transfer_rules.duration_limit`.<br /><br />Les options valides sont :<br />`0` - Entre la validation du tarif de départ de l'étape actuelle et la validation du tarif d'arrivée de l'étape suivante.<br />`1` - Entre la validation du tarif de départ de l'étape actuelle et la validation du tarif de départ de l'étape suivante.<br />`2` - Entre la validation du tarif d'arrivée du segment en cours et la validation du tarif de départ du segment suivant.<br />`3` - Entre la validation du tarif d'arrivée du segment en cours et la validation du tarif d'arrivée du segment suivant.<br /><br />Conditionnellement requis :<br />- **Obligatoire** si `fare_transfer_rules.duration_limit` est défini.<br />- **Interdit** si `fare_transfer_rules.duration_limit` est vide.                                                                                                                                                                                                                                                                                |
| `fare_transfer_type`  | Enum                                                                   | **Obligatoire**                | Indique la méthode de traitement des coûts pour le transfert entre les étapes d'un trajet : <br />![](../assets/2-leg.svg) <br />Les options valides sont :<br />`0` - De la jambe `fare_leg_rules.fare_product_id` plus `fare_transfer_rules.fare_product_id`; A + AB.<br />`1` - De la jambe `fare_leg_rules.fare_product_id` plus `fare_transfer_rules.fare_product_id` plus à-jambe `fare_leg_rules.fare_product_id`; A + AB + B.<br />`2` - `fare_transfer_rules.fare_product_id`; AB. <br /><br />Traitement des interactions entre plusieurs transferts au cours d'un trajet :<br />![](../assets/3-leg.svg)<br /><table/><thead></thead><tr></tr><th></th>`fare_transfer_type`</th><th></th>Traitement A > B</th><th></th>Traitement B > C</th></tr></thead><tbody></tbody><tr></tr><td></td>`0`</td><td></td>A + AB</td><td></td>S + BC</td></tr><tr></tr><td></td>`1`</td><td></td>A + AB +B</td><td></td>S + BC + C</td></tr><tr></tr><td></td>`2`</td><td></td>AB</td><td></td>S + BC</td></tr></tbody></table>Où S indique le coût total traité du ou des tronçons précédents et du ou des transferts. |
| `fare_product_id`     | Référencement d'identifiants étrangers `fare_products.fare_product_id` | Facultatif                     | Le produit tarifaire requis pour le transfert entre deux segments tarifaires. S'il est vide, le coût de la règle de transfert est égal à 0.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
